generator client {
  provider = "prisma-client-js"
}

// Usa DATABASE_URL (pooler) y DIRECT_URL (conexión directa).
// En Vercel + Supabase a veces se llaman POSTGRES_PRISMA_URL y POSTGRES_URL_NON_POOLING:
// pon en .env DATABASE_URL=<pooler> y DIRECT_URL=<direct>.
datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

/**
 * =====================
 * USER
 * =====================
 */
model User {
  id            String   @id @default(cuid())
  email         String   @unique
  passwordHash  String?  // Opcional para usuarios OAuth
  phone         String?
  role          UserRole
  emailVerified Boolean  @default(false)

  ndaSigned     Boolean  @default(false)
  dniVerified   Boolean  @default(false)
  
  blocked       Boolean  @default(false)
  blockedUntil  DateTime?

  // OAuth fields
  provider        String?  // "google" | null
  providerId      String?  // ID del proveedor OAuth
  name            String?  // Nombre completo del usuario
  image           String?  // URL de la imagen de perfil

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  companies          Company[]
  interests          Interest[]
  companyInterests   UserCompanyInterest[]
  accounts           Account[]
  sessions           Session[]
  companyFilesUploaded CompanyFile[]
}

// NextAuth.js models
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

/**
 * Interés del usuario en una empresa (solicitar info, favoritos/seguimiento).
 * companyId puede ser id mock (mock-1) o id real de Deal/Company.
 * status solo aplica a REQUEST_INFO: control admin (pendiente, gestionada, rechazada).
 */
model UserCompanyInterest {
  id        String   @id @default(cuid())
  companyId String
  type      CompanyInterestType
  status    RequestStatus? @default(PENDING) // solo para REQUEST_INFO
  createdAt DateTime @default(now())

  userId String
  user   User   @relation(fields: [userId], references: [id])

  @@unique([userId, companyId, type])
}

enum CompanyInterestType {
  REQUEST_INFO
  FAVORITE
}

enum RequestStatus {
  PENDING
  MANAGED
  REJECTED
}

/**
 * =====================
 * COMPANY
 * =====================
 */
/// Tipo de entidad: EMPRESA (tradicional), STARTUP, MARKETPLACE. Null = no especificado (registros legacy).
model Company {
  id          String        @id @default(cuid())
  name        String
  sector      String
  location    String
  revenue     String
  ebitda      String?       // Puede ser negativo, ej. "-50000"
  gmv         String?       // Gross Merchandise Value (volumen de negocio)
  employees   Int?
  description String?       // Resumen breve para listados y tarjetas
  sellerDescription String?  @db.Text  // Descripción amplia del vendedor (solo usuarios registrados)
  documentLinks       Json?    // [{ label: string, url: string }] enlaces a Drive, etc.
  attachmentsApproved Boolean  @default(false) // Si true, usuarios registrados pueden ver docs/enlaces/fotos
  status      CompanyStatus @default(DRAFT)
  createdAt   DateTime      @default(now())

  // Valoración mejorada: tipo de entidad, madurez, crecimiento, startup/marketplace
  companyType         String?   // "EMPRESA" | "STARTUP" | "MARKETPLACE" | null (NONE/legacy)
  yearsOperating      Int?      // Años en operación
  revenueGrowthPercent Float?   // Crecimiento interanual de facturación
  stage               String?   // Para startups: idea, pre_seed, seed, serie_a, etc.
  takeRatePercent     Float?    // Para marketplaces: % comisión sobre GMV
  arr                 Int?      // Annual Recurring Revenue (€), SaaS/subscriptions
  breakevenExpectedYear Int?    // Año esperado de breakeven (opcional)
  hasReceivedFunding  Boolean?  // Startup: si ha recibido financiación
  website             String?  // URL de la página web

  // Relations
  ownerId    String
  owner      User        @relation(fields: [ownerId], references: [id])
  documents  Document[]
  deals      Deal[]
  valuations Valuation[]
  companyFiles CompanyFile[]
}

/// Documentos subidos por el dueño de la empresa. Solo visibles para admin y dueño.
model CompanyFile {
  id            String   @id @default(cuid())
  companyId     String
  company       Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  uploadedById  String
  uploadedBy    User     @relation(fields: [uploadedById], references: [id], onDelete: Cascade)
  name          String   // nombre original del archivo
  storagePath   String   // ruta relativa en disco o URL en blob
  mimeType      String?  @default("application/octet-stream")
  size          Int?     // bytes
  kind          String   @default("document") // "document" | "image"
  createdAt     DateTime @default(now())
}

/**
 * =====================
 * DEAL
 * =====================
 */
model Deal {
  id        String   @id @default(cuid())
  title     String
  slug      String   @unique
  published Boolean  @default(false)
  createdAt DateTime @default(now())

  // Relations
  companyId String
  company   Company   @relation(fields: [companyId], references: [id])
  interests Interest[]
}

/**
 * =====================
 * DOCUMENT
 * =====================
 */
model Document {
  id        String       @id @default(cuid())
  type      DocumentType
  signed    Boolean      @default(false)
  signedAt  DateTime?
  createdAt DateTime     @default(now())

  // Relations
  companyId String
  company   Company @relation(fields: [companyId], references: [id])
}

/**
 * =====================
 * VALUATION
 * =====================
 */
model Valuation {
  id        String   @id @default(cuid())
  minValue  Int
  maxValue  Int
  createdAt DateTime @default(now())

  // Relations
  companyId String
  company   Company @relation(fields: [companyId], references: [id])
}

/**
 * =====================
 * INTEREST
 * =====================
 */
model Interest {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  // Relations
  userId String
  dealId String

  user User @relation(fields: [userId], references: [id])
  deal Deal @relation(fields: [dealId], references: [id])
}

/**
 * =====================
 * ENUMS
 * =====================
 */
enum UserRole {
  SELLER
  BUYER
  ADMIN
}

enum CompanyStatus {
  DRAFT
  IN_PROCESS
  PUBLISHED
  SOLD
}

enum DocumentType {
  SALES_MANDATE
  NDA
  AUTHORIZATION
}

/**
 * =====================
 * WAITLIST (landing)
 * =====================
 */
model WaitlistEntry {
  id        String   @id @default(cuid())
  email     String   @unique
  createdAt DateTime @default(now())
}

/**
 * =====================
 * CONTACTO (formularios)
 * =====================
 */
model ContactRequest {
  id            String   @id @default(cuid())
  source        String   // "contact" | "servicios"
  type          String   // "PARTICULAR" | "EMPRESA"
  name          String
  email         String
  phone         String?
  companyName   String?
  contactPerson String?  // persona a la que dirigirse (si empresa)
  subject       String?  // motivo de consulta (Valoración, Due diligence, etc.)
  message       String?  // texto libre
  createdAt     DateTime @default(now())
}

/// Leads del formulario "Valora tu empresa": datos de contacto + datos empresa + valoración orientativa (CRM).
model ValuationLead {
  id          String   @id @default(cuid())
  email       String
  phone       String
  companyName String?
  sector      String
  location    String
  revenue     Int      // facturación anual €
  ebitda      Int?     // EBITDA € (puede ser negativo)
  employees   Int?
  description String?  @db.Text
  minValue    Int      // valoración mínima €
  maxValue    Int      // valoración máxima €
  createdAt   DateTime @default(now())

  // Mismos campos que Company para valoración mejorada (todos opcionales para leads existentes)
  companyType         String?   // "EMPRESA" | "STARTUP" | "MARKETPLACE" | null
  yearsOperating      Int?
  revenueGrowthPercent Float?
  stage               String?
  takeRatePercent     Float?
  arr                 Int?
  breakevenExpectedYear Int?
  hasReceivedFunding  Boolean?
  website             String?  // URL de la página web
}
